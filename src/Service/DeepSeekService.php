<?php

namespace App\Service;

use Psr\Log\LoggerInterface;
use Symfony\Contracts\HttpClient\HttpClientInterface;

class DeepSeekService
{
    private const API_URL = 'https://api.deepseek.com/v1/chat/completions';
    private const MODEL = 'deepseek-chat';

    private const FALLBACK_COMPLIMENTS = [
        'wife' => [
            '–¢—ã –æ—Å–≤–µ—â–∞–µ—à—å –º–æ–π –º–∏—Ä —Å–≤–æ–µ–π —É–ª—ã–±–∫–æ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.',
            '–¢–≤–æ—è –¥–æ–±—Ä–æ—Ç–∞ –¥–µ–ª–∞–µ—Ç –º–∏—Ä –ª—É—á—à–µ.',
            '–†—è–¥–æ–º —Å —Ç–æ–±–æ–π —è —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è.',
            '–¢—ã —Å–∞–º–æ–µ –∫—Ä–∞—Å–∏–≤–æ–µ, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏.',
            '–¢–≤–æ–∏ –≥–ª–∞–∑–∞ ‚Äî –º–æ–∏ –ª—é–±–∏–º—ã–µ –∑–≤—ë–∑–¥—ã.',
            '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Å —Ç–æ–±–æ–π ‚Äî –ø–æ–¥–∞—Ä–æ–∫.',
            '–¢—ã —É–º–µ–µ—à—å –Ω–∞–π—Ç–∏ —Å–≤–µ—Ç –¥–∞–∂–µ –≤ —Å–∞–º—ã–µ —Ç—ë–º–Ω—ã–µ –¥–Ω–∏.',
            '–¢–≤–æ—è —É–ª—ã–±–∫–∞ ‚Äî –ª—É—á—à–µ–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ –æ—Ç –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º.',
            '–¢—ã –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—à—å –º–µ–Ω—è –±—ã—Ç—å –ª—É—á—à–µ.',
            '–° —Ç–æ–±–æ–π –¥–∞–∂–µ –æ–±—ã—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–æ–ª—à–µ–±–Ω—ã–º–∏.',
        ],
        'sister' => [
            '–¢—ã —Ç–∞–∫–∞—è —É–º–Ω–∏—á–∫–∞! –Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å! üåü',
            '–£ —Ç–µ–±—è –ø–æ–ª—É—á–∏—Ç—Å—è –≤—Å—ë, —á—Ç–æ —Ç—ã –∑–∞–¥—É–º–∞–µ—à—å! –í–µ—Ä—å –≤ —Å–µ–±—è! üí™',
            '–¢—ã –¥–µ–ª–∞–µ—à—å –º–∏—Ä —è—Ä—á–µ —Å–≤–æ–µ–π —É–ª—ã–±–∫–æ–π! ‚òÄÔ∏è',
            '–ö–∞–∫–∞—è –∂–µ —Ç—ã —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤–∞—è! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üé®',
            '–¢—ã —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è —Å —É—á—ë–±–æ–π –ø—Ä–æ—Å—Ç–æ –æ—Ç–ª–∏—á–Ω–æ! –Ø –≤ —Ç–µ–±—è –≤–µ—Ä—é! üìö',
            '–¢–≤–æ—è –¥–æ–±—Ä–æ—Ç–∞ –∏ –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å ‚Äî —ç—Ç–æ —Ç–≤–æ—è —Å—É–ø–µ—Ä—Å–∏–ª–∞! ‚ù§Ô∏è',
            '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Ç—ã —É–∑–Ω–∞—ë—à—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ, –∏ —ç—Ç–æ –∑–¥–æ—Ä–æ–≤–æ! üåà',
            '–ù–µ –±–æ–π—Å—è –æ—à–∏–±–∞—Ç—å—Å—è ‚Äî —Ç–∞–∫ –º—ã –≤—Å–µ —É—á–∏–º—Å—è! –¢—ã –º–æ–ª–æ–¥–µ—Ü! üöÄ',
            '–¢–≤–æ—è –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç! –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã! üí°',
            '–ü–æ–º–Ω–∏: —Ç—ã –º–æ–∂–µ—à—å –±–æ–ª—å—à–µ, —á–µ–º –¥—É–º–∞–µ—à—å! –í–ø–µ—Ä—ë–¥! üå∫',
        ],
    ];

    public function __construct(
        private HttpClientInterface $httpClient,
        private LoggerInterface $logger,
        private string $apiKey
    ) {
    }

    public function generateCompliment(?string $name = null, string $role = 'wife'): string
    {
        if (empty($this->apiKey) || $this->apiKey === 'your_deepseek_api_key_here') {
            return $this->getFallbackCompliment($role);
        }

        try {
            $prompt = $this->buildPrompt($name, $role);

            $response = $this->httpClient->request('POST', self::API_URL, [
                'headers' => [
                    'Content-Type' => 'application/json',
                    'Authorization' => 'Bearer ' . $this->apiKey,
                ],
                'json' => [
                    'model' => self::MODEL,
                    'messages' => [
                        [
                            'role' => 'user',
                            'content' => $prompt,
                        ],
                    ],
                    'max_tokens' => 200,
                    'temperature' => 0.8,
                ],
            ]);

            $data = $response->toArray();

            if (isset($data['choices'][0]['message']['content'])) {
                return trim($data['choices'][0]['message']['content']);
            }

            $this->logger->warning('Unexpected DeepSeek API response', ['response' => $data]);
            return $this->getFallbackCompliment($role);
        } catch (\Exception $e) {
            $this->logger->error('DeepSeek API error', ['error' => $e->getMessage()]);
            return $this->getFallbackCompliment($role);
        }
    }

    private function buildPrompt(?string $name, string $role): string
    {
        $namePhrase = $name ? " –¥–ª—è {$name}" : '';

        if ($role === 'sister') {
            return <<<PROMPT
–ù–∞–ø–∏—à–∏ –æ–¥–Ω–æ —Ç—ë–ø–ª–æ–µ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ{$namePhrase} ‚Äî –¥–ª—è 10-–ª–µ—Ç–Ω–µ–π –¥–µ–≤–æ—á–∫–∏-—à–∫–æ–ª—å–Ω–∏—Ü—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –î—Ä—É–∂–µ—Å–∫–æ–µ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ —É—á—ë–±–µ –∏–ª–∏ –¥–æ–±—Ä—ã–µ —Å–ª–æ–≤–∞
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1-2 —ç–º–æ–¥–∑–∏ (–Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –ù–µ –±–æ–ª–µ–µ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
- –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

–ù–∞–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π.
PROMPT;
        }

        // Default: wife role
        return <<<PROMPT
–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∫—Ä–∞—Å–∏–≤—ã–π, –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç{$namePhrase} –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç—ë–ø–ª—ã–º –∏ –Ω–µ–∂–Ω—ã–º
- –ù–µ –±–æ–ª–µ–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ —Ç–∏–ø–∞ "–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç:"
- –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞

–ù–∞–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π.
PROMPT;
    }

    private function getFallbackCompliment(string $role): string
    {
        $compliments = self::FALLBACK_COMPLIMENTS[$role] ?? self::FALLBACK_COMPLIMENTS['wife'];
        return $compliments[array_rand($compliments)];
    }
}
